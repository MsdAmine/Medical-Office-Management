@* File: Views/Appointments/_AppointmentsTable.cshtml *@
@model MedicalOfficeManagement.ViewModels.Appointments.AppointmentsIndexViewModel

@{
    var kpis = new List<KpiCardModel>
    {
        new KpiCardModel { Label = "Today's Appointments", Value = Model.TodayCount.ToString(), Helper = "Clinically scheduled", DeltaTone = "neutral" },
        new KpiCardModel { Label = "Confirmed", Value = Model.ConfirmedCount.ToString(), Helper = "Checked-in or pre-registered", DeltaTone = "success" },
        new KpiCardModel { Label = "Waiting", Value = Model.WaitingCount.ToString(), Helper = "In lobby / triage", DeltaTone = "warning" },
        new KpiCardModel { Label = "Utilization", Value = Model.TodayCount == 0 ? "0%" : "75%", Helper = "Capacity booked today", DeltaTone = "neutral" }
    };
    var canManage = User.IsInRole(nameof(AppRole.Admin)) || User.IsInRole(nameof(AppRole.Physician)) || User.IsInRole(nameof(AppRole.Nurse)) || User.IsInRole(nameof(AppRole.Receptionist));
    var isBilling = User.IsInRole(nameof(AppRole.Billing));
}

<div class="flex items-center justify-between gap-3 mb-2">
    <p class="text-xs text-slate-500">KPIs: Aggregated metrics for operational awareness and staffing readiness.</p>
</div>
@await Html.PartialAsync("Partials/KpiGrid", new KpiGridModel { Items = kpis })

@await Html.PartialAsync("Partials/TableShell", new TableShellModel
{
    Title = "Appointment list",
    Description = "Time, status, arrival indicators, and actions. Late = arrival > 10 minutes; High Risk = priority review.",
    TableContent = @<text>
        @if (!Model.Appointments.Any())
        {
            @await Html.PartialAsync("Partials/EmptyState", new EmptyStateModel
            {
                Title = "No appointments scheduled",
                Body = "Schedule a patient to see live status, rooming, and handoffs.",
                Icon = "solar:calendar-add-bold",
                PrimaryAction = new ToolbarAction { Label = "Schedule", Href = Url.Action("Create", "Appointments"), Style = "primary" }
            })
        }
        else
        {
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Patient</th>
                        <th>Doctor</th>
                        <th>Visit Type</th>
                        <th>Duration</th>
                        <th>Room</th>
                        <th>Status</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var appointment in Model.Appointments)
                    {
                        var statusClass = appointment.Status switch
                        {
                            "Confirmed" => "badge success",
                            "Waiting" => "badge warning",
                            "Cancelled" => "badge danger",
                            _ => "badge info"
                        };
                        <tr class="text-sm align-top hover:bg-slate-50/70 transition">
                            <td>
                                <div class="flex items-center gap-2">
                                    <div class="text-sm font-semibold text-slate-900">@appointment.Time.ToString("h:mm tt")</div>
                                    @if (appointment.IsLate)
                                    {
                                        <span class="chip high" title="Arrival over 10 minutes late">Late</span>
                                    }
                                    @if (appointment.HasOverlap)
                                    {
                                        <span class="chip medium">Overlap</span>
                                    }
                                </div>
                                <div class="text-xs text-slate-500">@appointment.Time.ToString("MMM dd, yyyy")</div>
                            </td>
                            <td>
                                <div class="text-sm font-semibold text-brand-700">@appointment.PatientName</div>
                                <div class="text-xs text-slate-500">Last: @appointment.PatientLastVisitRelative</div>
                                <div class="flex flex-wrap gap-2 mt-1">
                                    @foreach (var flag in appointment.PatientRiskFlags)
                                    {
                                        <span class="chip medium" title="High Risk = priority review before rooming">
                                            <span class="h-2 w-2 rounded-full bg-current/60"></span>
                                            @flag
                                        </span>
                                    }
                                </div>
                            </td>
                            <td>
                                <div class="font-medium text-slate-900">@appointment.DoctorName</div>
                                <div class="text-xs text-slate-500">On duty</div>
                            </td>
                            <td>
                                <span class="chip active">
                                    <span class="h-2 w-2 rounded-full bg-current/60"></span>
                                    @appointment.VisitType
                                </span>
                            </td>
                            <td>@appointment.DurationLabel</td>
                            <td>@appointment.Room</td>
                            <td>
                                <span class="@statusClass">@appointment.Status</span>
                                <div class="text-xs text-slate-500">Upcoming: @appointment.PatientUpcoming</div>
                            </td>
                                <td class="text-right">
                                    @await Html.PartialAsync("Partials/ActionMenu", new ActionMenuModel
                                    {
                                        Items = new []
                                        {
                                            new ActionMenuItem { Label = "Details", Href = Url.Action("Details", "Appointments", new { id = appointment.Id }) },
                                            new ActionMenuItem
                                            {
                                                Label = "Edit",
                                                Href = canManage && !isBilling ? Url.Action("Edit", "Appointments", new { id = appointment.Id }) : null,
                                                Disabled = !canManage || isBilling,
                                                Tone = "warning"
                                            }
                                        }
                                    })
                                </td>
                            </tr>
                        }
                </tbody>
            </table>
        }
    </text>
})
