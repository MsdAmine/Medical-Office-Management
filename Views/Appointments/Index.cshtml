@* File: Views/Appointments/Index.cshtml *@
@model MedicalOfficeManagement.ViewModels.Appointments.AppointmentsIndexViewModel

@{
    ViewBag.Title = "Appointments";
    var canSchedule = User.IsInRole(nameof(AppRole.Admin)) ||
                      User.IsInRole(nameof(AppRole.Physician)) ||
                      User.IsInRole(nameof(AppRole.Nurse)) ||
                      User.IsInRole(nameof(AppRole.Receptionist));
    var isBilling = User.IsInRole(nameof(AppRole.Billing));
    var roleIntent = User.IsInRole(nameof(AppRole.Admin))
        ? "Operational oversight and escalation control"
        : canSchedule
            ? "Arrivals, scheduling, and patient flow"
            : "View-only monitoring for billing and reporting";
    var presetOptions = new List<PresetOption>
    {
        new PresetOption { Label = "Default", Url = Url.Action("Index", "Appointments", new { clearPreset = true }), Active = !Model.FilterContext.HasActivePreset, Description = "All appointments" }
    };
    presetOptions.AddRange(Model.FilterContext.Presets.Select(p => new PresetOption
    {
        Label = p.Name,
        Url = Url.Action("Index", "Appointments", new { presetId = p.Id }),
        Active = Model.FilterContext.IsPresetActive(p.Id),
        Description = p.CreatedByRole
    }));
    var filterChips = new List<FilterChipModel>();
    if (!string.IsNullOrWhiteSpace(Model.FilterContext.CurrentFilters.Doctor))
    {
        filterChips.Add(new FilterChipModel { Label = $"Doctor: {Model.FilterContext.CurrentFilters.Doctor}", Tone = "active" });
    }
    if (!string.IsNullOrWhiteSpace(Model.FilterContext.CurrentFilters.Status))
    {
        filterChips.Add(new FilterChipModel { Label = $"Status: {Model.FilterContext.CurrentFilters.Status}", Tone = "warning" });
    }
    if (Model.FilterContext.CurrentFilters.StartDate.HasValue || Model.FilterContext.CurrentFilters.EndDate.HasValue)
    {
        filterChips.Add(new FilterChipModel { Label = $"Range: {Model.FilterContext.CurrentFilters.StartDate:MMM dd} - {Model.FilterContext.CurrentFilters.EndDate:MMM dd}", Tone = "success" });
    }
}

<div class="space-y-6">
    <p class="text-[13px] text-slate-600 font-medium">@roleIntent</p>
    @await Html.PartialAsync("Partials/PageHeader", new PageHeaderModel
    {
        Title = "Appointments",
        Subtitle = "Segmented control for list or calendar. Arrival indicators and check-in ready.",
        ContextTag = "Schedule",
        RoleBadge = isBilling ? "Billing view-only" : canSchedule ? "Scheduling enabled" : "View only",
        RoleTone = canSchedule ? "success" : "warning",
        Actions = new []
        {
            new ToolbarAction { Label = "Schedule appointment", Style = "primary", DataTarget = "#appointment-modal", IsButton = true, Disabled = !canSchedule, Tooltip = "Available to clinical and front desk roles" },
            new ToolbarAction { Label = "Open calendar", Href = "#", Style = "secondary" }
        }
    })

    @await Html.PartialAsync("Partials/PresetsBar", new PresetsBarModel { Title = "Presets", Options = presetOptions })

    <div class="card p-5 space-y-5 shadow-[0_2px_4px_rgba(0,0,0,0.05)]">
        <p class="text-xs text-slate-600">Late = arrival > 10 minutes past slot. High Risk flags require priority review before rooming.</p>
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="flex gap-2">
                <button class="btn btn-secondary">
                    <span class="iconify w-4 h-4" data-icon="solar:list-bold"></span>
                    List view
                </button>
                <button class="btn btn-ghost text-slate-600 hover:text-slate-900">
                    <span class="iconify w-4 h-4" data-icon="solar:calendar-bold"></span>
                    Calendar
                </button>
            </div>
            @await Html.PartialAsync("Partials/FilterChips", new FilterChipsModel { Chips = filterChips.Any() ? filterChips : new [] { new FilterChipModel { Label = "No filters", Tone = "muted" } } })
        </div>

        <form method="get" class="grid grid-cols-1 lg:grid-cols-5 gap-3 items-end">
            <input type="hidden" name="clearPreset" value="true" />
            <div class="lg:col-span-2">
                <label class="form-label">Date range</label>
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <input type="date" name="StartDate" value="@(Model.FilterContext.CurrentFilters.StartDate?.ToString("yyyy-MM-dd") ?? string.Empty)" class="form-input pr-10 placeholder:text-slate-500" />
                        <span class="iconify w-4 h-4 text-slate-500 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" data-icon="solar:calendar-bold"></span>
                    </div>
                    <div class="relative flex-1">
                        <input type="date" name="EndDate" value="@(Model.FilterContext.CurrentFilters.EndDate?.ToString("yyyy-MM-dd") ?? string.Empty)" class="form-input pr-10 placeholder:text-slate-500" />
                        <span class="iconify w-4 h-4 text-slate-500 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" data-icon="solar:calendar-bold"></span>
                    </div>
                </div>
            </div>
            <div>
                <label class="form-label">Doctor</label>
                <select name="Doctor" class="form-input">
                    <option value="">All Doctors</option>
                    @foreach (var doctor in Model.DoctorOptions)
                    {
                        <option value="@doctor" selected="@(string.Equals(Model.FilterContext.CurrentFilters.Doctor, doctor, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@doctor</option>
                    }
                </select>
            </div>
            <div>
                <label class="form-label">Status</label>
                <select name="Status" class="form-input">
                    <option value="">All Status</option>
                    @foreach (var status in Model.StatusOptions)
                    {
                        <option value="@status" selected="@(string.Equals(Model.FilterContext.CurrentFilters.Status, status, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@status</option>
                    }
                </select>
            </div>
            <div class="flex gap-2 justify-end">
                <button type="submit" class="btn btn-primary">Apply</button>
                <a asp-action="Index" asp-controller="Appointments" asp-route-clearPreset="true" class="btn btn-secondary">Clear</a>
            </div>
        </form>

        <form method="post" asp-action="SavePreset" class="grid grid-cols-1 lg:grid-cols-3 gap-3 items-end">
            @Html.AntiForgeryToken()
            <div class="lg:col-span-2">
                <label class="form-label">Save filters as preset</label>
                <input type="text" name="presetName" class="form-input placeholder:text-slate-500" placeholder="e.g., Today confirmed" required />
                <div class="flex items-center gap-2 mt-2">
                    <input id="appointments-default" type="checkbox" name="setAsDefault" class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500" />
                    <label for="appointments-default" class="text-sm text-slate-700">Set as default</label>
                </div>
            </div>
            <div class="hidden">
                <input type="hidden" name="Doctor" value="@Model.FilterContext.CurrentFilters.Doctor" />
                <input type="hidden" name="Status" value="@Model.FilterContext.CurrentFilters.Status" />
                <input type="hidden" name="StartDate" value="@(Model.FilterContext.CurrentFilters.StartDate?.ToString("o"))" />
                <input type="hidden" name="EndDate" value="@(Model.FilterContext.CurrentFilters.EndDate?.ToString("o"))" />
            </div>
            <button type="submit" class="btn btn-secondary">Save preset</button>
        </form>
    </div>

    <div id="appointments-live-container"
         data-partial-url="@($"{Url.Action("LiveTable", "Appointments")}{Context.Request.QueryString}")">
        @await Html.PartialAsync("_AppointmentsTable", Model)
    </div>
</div>

<div id="appointment-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
    <div class="surface w-full max-w-2xl p-6 space-y-5 shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-slate-900">Schedule Appointment</h2>
                <p class="text-sm text-slate-500">Create a new appointment without leaving the page.</p>
            </div>
            <button type="button" class="text-slate-500 hover:text-slate-700" data-close-modal>
                <span class="sr-only">Close</span>
                &times;
            </button>
        </div>
        <form action="@Url.Action("Create", "Appointments")" method="post" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="form-label">Patient</label>
                    <input type="text" name="PatientName" class="form-input" placeholder="Patient name" required>
                </div>
                <div class="form-field">
                    <label class="form-label">Doctor</label>
                    <input type="text" name="DoctorName" class="form-input" placeholder="Doctor name" required>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="form-field sm:col-span-2">
                    <label class="form-label">Date</label>
                    <input type="date" name="Date" class="form-input" required>
                </div>
                <div class="form-field">
                    <label class="form-label">Time</label>
                    <input type="time" name="Time" class="form-input" required>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="form-label">Type</label>
                    <select name="AppointmentType" class="form-input">
                        <option value="Consultation">Consultation</option>
                        <option value="Follow-up">Follow-up</option>
                        <option value="Procedure">Procedure</option>
                    </select>
                </div>
                <div class="form-field">
                    <label class="form-label">Status</label>
                    <select name="Status" class="form-input">
                        <option value="Confirmed">Confirmed</option>
                        <option value="Waiting">Waiting</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 pt-2">
                <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
                <button type="submit" class="btn-primary">Save Appointment</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('appointment-modal');
        const toggleModal = (isOpen) => modal?.classList.toggle('hidden', !isOpen);

        document.querySelectorAll('[data-target="#appointment-modal"]').forEach(btn => {
            btn.addEventListener('click', () => toggleModal(true));
        });

        modal?.addEventListener('click', (event) => {
            if (event.target === modal) {
                toggleModal(false);
            }
        });

        document.querySelectorAll('[data-close-modal]').forEach(button => {
            button.addEventListener('click', () => toggleModal(false));
        });
    });
</script>
