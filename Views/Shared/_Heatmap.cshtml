@model MedicalOfficeManagement.ViewModels.Heatmaps.HeatmapViewModel

@{
    var bucketLabels = Model.Rows.FirstOrDefault()?.Buckets ?? new List<MedicalOfficeManagement.ViewModels.Heatmaps.HeatmapBucketViewModel>();
    string IntensityClass(int intensity) => intensity switch
    {
        0 => "bg-slate-50 text-slate-700",
        1 => "bg-blue-50 text-slate-700",
        2 => "bg-blue-100 text-slate-800",
        3 => "bg-blue-200 text-slate-900",
        _ => "bg-blue-300 text-slate-900"
    };
}

@if (!bucketLabels.Any() || Model.Rows.Count == 0)
{
    <div class="p-6 text-sm text-slate-500">No workload data available for this range.</div>
}
else
{
    <div class="overflow-auto">
        <div class="min-w-full">
            <div class="grid" style="grid-template-columns: 170px repeat(@bucketLabels.Count, minmax(52px, 1fr));">
                <div class="sticky left-0 z-10 bg-white border border-slate-100 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-500">Provider</div>
                @foreach (var bucket in bucketLabels)
                {
                    <div class="border border-slate-100 px-3 py-2 text-[11px] font-semibold text-slate-500 text-center">@bucket.Label</div>
                }

                @foreach (var row in Model.Rows)
                {
                    <div class="sticky left-0 z-10 bg-white border border-slate-100 px-3 py-3 text-sm font-semibold text-slate-800 flex items-center justify-between gap-2">
                        <span>@row.RowLabel</span>
                        @if (!string.IsNullOrEmpty(row.SummaryText))
                        {
                            <span class="text-[11px] text-slate-500">@row.SummaryText</span>
                        }
                    </div>
                    @foreach (var bucket in row.Buckets)
                    {
                        var tooltipId = $"tip-{row.RowLabel.GetHashCode()}-{bucket.StartTime:HHmm}";
                        <div class="group relative flex h-12 items-center justify-center border border-slate-100 text-xs font-semibold rounded-none @IntensityClass(bucket.Intensity)"
                             aria-label="@($"{row.RowLabel} {bucket.Label}: {bucket.Tooltip}")">
                            <span>@bucket.LoadCount</span>
                            <span class="sr-only">@bucket.Tooltip</span>
                            <div id="@tooltipId" class="pointer-events-none absolute left-1/2 top-full z-20 hidden min-w-[160px] -translate-x-1/2 transform rounded-lg border border-slate-200 bg-white px-3 py-2 text-[11px] font-medium text-slate-700 shadow-lg group-hover:block">
                                <div class="text-[10px] uppercase tracking-wide text-slate-500">@bucket.Label</div>
                                <div>@bucket.Tooltip</div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-slate-600">
        <span class="font-semibold text-slate-700">Legend:</span>
        @foreach (var legend in Model.Legend)
        {
            <div class="inline-flex items-center gap-2">
                <span class="h-4 w-7 rounded @IntensityClass(legend.Intensity) border border-slate-100"></span>
                <span>@legend.Label</span>
                <span class="text-slate-400">(@legend.Description)</span>
            </div>
        }
    </div>
}
