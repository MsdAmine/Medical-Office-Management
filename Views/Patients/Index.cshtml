@model MedicalOfficeManagement.ViewModels.Patients.PatientsIndexViewModel

@{
    var primaryCta = "btn btn-primary";
    var secondaryCta = "btn btn-secondary";
    var tertiaryCta = "btn btn-ghost text-brand-700 hover:text-brand-800";
    var isAdmin = User.IsInRole(nameof(AppRole.Admin));
    var isPhysician = User.IsInRole(nameof(AppRole.Physician));
    var isReceptionist = User.IsInRole(nameof(AppRole.Receptionist));
    var isBilling = User.IsInRole(nameof(AppRole.Billing));
    var canEdit = isAdmin || isReceptionist || isPhysician;
    var roleIntent = isAdmin
        ? "Operational oversight and escalation control"
        : isPhysician
            ? "Patient care and clinical priorities"
            : isReceptionist
                ? "Arrivals, scheduling, and patient flow"
                : "Billing insight with clinical read-only context";
    string GetFlagClass(string flag) => flag switch
    {
        "Chronic" => "chip medium",
        "High Risk" => "chip high",
        "Follow-up Due" => "chip active",
        "High" => "chip high",
        "Moderate" => "chip medium",
        _ => "chip"
    };
    var presetOptions = new List<PresetOption>
    {
        new PresetOption { Label = "Default", Url = Url.Action("Index", "Patients", new { clearPreset = true }), Active = !Model.FilterContext.HasActivePreset, Description = "All patients" }
    };
    presetOptions.AddRange(Model.FilterContext.Presets.Select(p => new PresetOption
    {
        Label = p.Name,
        Url = Url.Action("Index", "Patients", new { presetId = p.Id }),
        Active = Model.FilterContext.IsPresetActive(p.Id),
        Description = p.CreatedByRole
    }));
    var activeChips = new List<FilterChipModel>();
    if (!string.IsNullOrWhiteSpace(Model.FilterContext.CurrentFilters.PrimaryDoctor))
    {
        activeChips.Add(new FilterChipModel { Label = $"Doctor: {Model.FilterContext.CurrentFilters.PrimaryDoctor}", Tone = "active" });
    }
    if (!string.IsNullOrWhiteSpace(Model.FilterContext.CurrentFilters.RiskLevel))
    {
        activeChips.Add(new FilterChipModel { Label = $"Flag: {Model.FilterContext.CurrentFilters.RiskLevel}", Tone = "warning" });
    }
    if (Model.FilterContext.CurrentFilters.FollowUpDueOnly)
    {
        activeChips.Add(new FilterChipModel { Label = "Follow-ups due", Tone = "danger" });
    }
}

<div class="space-y-6">
    @{
        var header = new PageHeaderModel
        {
            Title = "Patient Directory",
            Subtitle = "Clinical identity, follow-ups, and communication ready for each role.",
            ContextTag = "Patients",
            RoleBadge = isBilling ? "Billing view" : isPhysician ? "Physician view" : isReceptionist ? "Front desk" : "Admin",
            RoleTone = isBilling ? "warning" : "info",
            Actions = new[]
            {
                new ToolbarAction { Label = "Register patient", Href = Url.Action("Create", "Patients"), Style = "primary", Disabled = !canEdit },
                new ToolbarAction { Label = "Today appointments", Href = Url.Action("Index", "Appointments"), Style = "secondary" },
                new ToolbarAction { Label = "Export roster", Href = Url.Action("Index", "Reports"), Style = "ghost" }
            }
        };
    }
    <p class="text-[13px] text-slate-500 font-medium">@roleIntent</p>
    @await Html.PartialAsync("Partials/PageHeader", header)

    @await Html.PartialAsync("Partials/PresetsBar", new PresetsBarModel
    {
        Title = "Filters & presets",
        Options = presetOptions
    })

    <div class="card p-5 space-y-4">
        <div class="text-xs text-slate-500 flex flex-wrap gap-4">
            <span>Clinical flags: High Risk = requires priority review; Chronic = sustained management plan.</span>
            <span>Late = arrival over 10 minutes past slot; highlight for front desk and clinicians.</span>
        </div>
        @await Html.PartialAsync("Partials/FilterChips", new FilterChipsModel
        {
            Title = "Active filters",
            Chips = activeChips.Any() ? activeChips : new List<FilterChipModel> { new FilterChipModel { Label = "None", Tone = "muted" } }
        })

        <form method="get" class="grid grid-cols-1 lg:grid-cols-4 gap-3 items-end">
            <input type="hidden" name="clearPreset" value="true" />
            <div class="lg:col-span-2">
                <label class="form-label">Search patients</label>
                <div class="relative">
                    <input type="text" name="Search" class="form-input pl-10" placeholder="Search by name, ID, or contact" />
                    <span class="iconify w-5 h-5 absolute left-3 top-2.5 text-slate-400" data-icon="solar:magnifer-bold"></span>
                </div>
                <p class="form-help">Reception: focus on contact. Physician: focus on clinical flags.</p>
            </div>
            <div>
                <label class="form-label">Primary doctor</label>
                <select name="PrimaryDoctor" class="form-input">
                    <option value="">All doctors</option>
                    @foreach (var doctor in Model.DoctorOptions)
                    {
                        <option value="@doctor" selected="@(string.Equals(Model.FilterContext.CurrentFilters.PrimaryDoctor, doctor, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@doctor</option>
                    }
                </select>
            </div>
            <div>
                <label class="form-label">Clinical flag</label>
                <select name="RiskLevel" class="form-input">
                    <option value="">Any flag</option>
                    @foreach (var risk in Model.RiskLevels)
                    {
                        <option value="@risk" selected="@(string.Equals(Model.FilterContext.CurrentFilters.RiskLevel, risk, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@risk</option>
                    }
                </select>
            </div>
            <div class="flex items-center gap-2">
                <input id="follow-up-only" type="checkbox" name="FollowUpDueOnly" value="true" checked="@(Model.FilterContext.CurrentFilters.FollowUpDueOnly ? "checked" : null)" class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500" />
                <label for="follow-up-only" class="text-sm text-slate-700">Follow-ups due only</label>
            </div>
            <div class="flex gap-2 lg:col-span-2 justify-end">
                <button type="submit" class="@primaryCta">Apply filters</button>
                <a asp-action="Index" asp-controller="Patients" asp-route-clearPreset="true" class="@secondaryCta">Clear</a>
            </div>
        </form>

        <form method="post" asp-action="SavePreset" class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            @Html.AntiForgeryToken()
            <div class="md:col-span-2">
                <label class="form-label">Save current filters</label>
                <input type="text" name="presetName" class="form-input" placeholder="e.g., Follow-ups by Dr. Chen" required />
                <div class="flex items-center gap-2 mt-2">
                    <input id="patients-default" type="checkbox" name="setAsDefault" class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500" />
                    <label for="patients-default" class="text-sm text-slate-700">Set as default</label>
                </div>
            </div>
            <div class="hidden">
                <input type="hidden" name="PrimaryDoctor" value="@Model.FilterContext.CurrentFilters.PrimaryDoctor" />
                <input type="hidden" name="RiskLevel" value="@Model.FilterContext.CurrentFilters.RiskLevel" />
                <input type="hidden" name="FollowUpDueOnly" value="@Model.FilterContext.CurrentFilters.FollowUpDueOnly" />
            </div>
            <button type="submit" class="@secondaryCta">Save preset</button>
        </form>
    </div>

    @if (!Model.Patients.Any())
    {
        @await Html.PartialAsync("Partials/EmptyState", new EmptyStateModel
        {
            Title = "No patients yet",
            Body = "Start your directory by adding a new patient record. Reception can register, physician can review follow-ups, billing can link invoices.",
            Icon = "solar:user-plus-bold",
            PrimaryAction = new ToolbarAction { Label = "Add patient", Href = Url.Action("Create", "Patients"), Style = "primary", Disabled = !canEdit },
            SecondaryAction = new ToolbarAction { Label = "View todayâ€™s visits", Href = Url.Action("Index", "Appointments"), Style = "secondary" }
        })
    }
    else
    {
        @await Html.PartialAsync("Partials/TableShell", new TableShellModel
        {
            Title = "Patient roster",
            Description = "Dense identity view with clinical flags, contact, and scheduling context.",
            Actions = new [] { new ToolbarAction { Label = "Export CSV", Href = Url.Action("Index", "Reports"), Style = "ghost" } },
            TableContent = @<text>
                <table>
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>Clinical</th>
                            <th>Primary Doctor</th>
                            <th>Contact</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Patients)
                        {
                            <tr class="align-top hover:bg-slate-50/70 transition">
                                <td>
                                    <div class="font-semibold text-slate-900">@item.FullName</div>
                                    <div class="text-xs text-slate-500">ID: #PT-@item.Id.ToString("D4")</div>
                                </td>
                                <td>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="chip active">@item.LastVisitRelative</span>
                                        <span class="chip">@((item.LastVisit?.ToString("MMM dd, yyyy")) ?? "No history")</span>
                                        @foreach (var flag in item.ClinicalFlags)
                                        {
                                            <span class="@GetFlagClass(flag)">
                                                <span class="h-2 w-2 rounded-full bg-current/60"></span>
                                                @flag
                                            </span>
                                        }
                                    </div>
                                    @if (isPhysician)
                                    {
                                        <p class="text-xs text-slate-500 mt-1">Clinical focus: last visit and upcoming follow-ups.</p>
                                    }
                                </td>
                                <td>
                                    <div class="font-medium text-slate-900">@item.PrimaryDoctor</div>
                                    <div class="text-xs text-slate-500">Care coordinator</div>
                                </td>
                                <td>
                                    <div class="font-medium text-slate-900">@item.Phone</div>
                                    <div class="text-xs text-slate-500">@item.Email</div>
                                    @if (isReceptionist)
                                    {
                                        <p class="text-xs text-emerald-600 mt-1">Ready for scheduling</p>
                                    }
                                    @if (isBilling)
                                    {
                                        <p class="text-xs text-slate-500 mt-1">Invoice links available in Billing</p>
                                    }
                                </td>
                                <td class="text-right">
                                    @await Html.PartialAsync("Partials/ActionMenu", new ActionMenuModel
                                    {
                                        Items = new []
                                        {
                                            new ActionMenuItem { Label = "View chart", Href = Url.Action("Details", new { id = item.Id }) },
                                            new ActionMenuItem { Label = "Edit", Href = Url.Action("Edit", new { id = item.Id }), Disabled = !canEdit },
                                            new ActionMenuItem { Label = "Schedule visit", Href = Url.Action("Create", "Appointments", new { patientId = item.Id }), Tone = "success", Disabled = isBilling },
                                            new ActionMenuItem { Label = "Billing record", Href = Url.Action("Index", "Billing"), Tone = "warning", Disabled = !(isBilling || isAdmin) }
                                        }
                                    })
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </text>
        })
    }
</div>
