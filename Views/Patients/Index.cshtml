@model MedicalOfficeManagement.ViewModels.Patients.PatientsIndexViewModel

@{
    var primaryCta = "btn-primary px-4 py-2";
    var secondaryCta = "btn-secondary px-4 py-2";
    var tertiaryCta = "btn-ghost text-brand-700 hover:text-brand-800 px-2 py-1";

    string GetFlagClass(string flag) => flag switch
    {
        "Chronic" => "bg-amber-50 text-amber-700 ring-amber-200",
        "High Risk" => "bg-rose-50 text-rose-700 ring-rose-200",
        "Follow-up Due" => "bg-indigo-50 text-indigo-700 ring-indigo-200",
        _ => "bg-slate-50 text-slate-700 ring-slate-200"
    };
}

<div class="page-shell">
    <div class="page-header">
        <div class="space-y-1">
            <div class="inline-flex items-center gap-2 rounded-full bg-brand-50 text-brand-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide">Patients</div>
            <h1 class="page-title">Patient Directory</h1>
            <p class="page-subtitle">Search, triage, and maintain patient records.</p>
        </div>
        <a asp-action="Create" class="@primaryCta">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Register New Patient
        </a>
    </div>

    <div class="space-y-4 mb-6">
        @await Html.PartialAsync("Filters/_PresetSelector", new MedicalOfficeManagement.ViewModels.Filters.PresetSelectorViewModel
        {
            Context = Model.FilterContext,
            ControllerName = "Patients"
        })

        <div class="surface border border-slate-200 bg-white p-4 rounded-xl shadow-sm space-y-4">
            <form method="get" class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
                <input type="hidden" name="clearPreset" value="true" />
                <div class="flex flex-wrap gap-3">
                    <div class="form-field">
                        <label class="form-label">Primary doctor</label>
                        <select name="PrimaryDoctor" class="form-input">
                            <option value="">All doctors</option>
                            @foreach (var doctor in Model.DoctorOptions)
                            {
                                <option value="@doctor" selected="@(string.Equals(Model.FilterContext.CurrentFilters.PrimaryDoctor, doctor, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@doctor</option>
                            }
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Clinical flag</label>
                        <select name="RiskLevel" class="form-input">
                            <option value="">Any flag</option>
                            @foreach (var risk in Model.RiskLevels)
                            {
                                <option value="@risk" selected="@(string.Equals(Model.FilterContext.CurrentFilters.RiskLevel, risk, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@risk</option>
                            }
                        </select>
                    </div>
                    <div class="flex items-center gap-2 pt-6">
                        <input id="follow-up-only" type="checkbox" name="FollowUpDueOnly" value="true" checked="@(Model.FilterContext.CurrentFilters.FollowUpDueOnly ? "checked" : null)" class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500" />
                        <label for="follow-up-only" class="text-sm text-slate-700">Follow-ups due only</label>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button type="submit" class="@primaryCta">Apply filters</button>
                    <a asp-action="Index" asp-controller="Patients" asp-route-clearPreset="true" class="@secondaryCta">Clear filters</a>
                </div>
            </form>

            <form method="post" asp-action="SavePreset" class="flex flex-col gap-3 lg:flex-row lg:items-end lg:gap-4">
                @Html.AntiForgeryToken()
                <div class="form-field flex-1">
                    <label class="form-label">Preset name</label>
                    <input type="text" name="presetName" class="form-input" placeholder="e.g., Follow-ups by Dr. Chen" required />
                </div>
                <div class="flex items-center gap-2">
                    <input id="patients-default" type="checkbox" name="setAsDefault" class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500" />
                    <label for="patients-default" class="text-sm text-slate-700">Set as default for patients</label>
                </div>
                <div class="hidden">
                    <input type="hidden" name="PrimaryDoctor" value="@Model.FilterContext.CurrentFilters.PrimaryDoctor" />
                    <input type="hidden" name="RiskLevel" value="@Model.FilterContext.CurrentFilters.RiskLevel" />
                    <input type="hidden" name="FollowUpDueOnly" value="@Model.FilterContext.CurrentFilters.FollowUpDueOnly" />
                </div>
                <button type="submit" class="@primaryCta">Save current filters as preset</button>
            </form>
        </div>
    </div>

    @if (!Model.Patients.Any())
    {
        <div class="empty-state">
            <div class="mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full bg-brand-50 text-brand-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </div>
            <div class="space-y-1">
                <div class="empty-state__title">No patients yet</div>
                <p class="empty-state__body">Start your directory by adding a new patient record. You can also jump to today’s visits to keep context.</p>
            </div>
            <div class="mt-4 flex flex-wrap items-center justify-center gap-3">
                <a asp-action="Create" class="@primaryCta">Add Patient</a>
                <a href="@Url.Action("Index", "Appointments")" class="@tertiaryCta">View today’s visits</a>
            </div>
        </div>
    }
    else
    {
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Patient</th>
                        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Last Visit</th>
                        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Primary Doctor</th>
                        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Clinical Flags</th>
                        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500">Contact</th>
                        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    @foreach (var item in Model.Patients) {
                    <tr class="hover:bg-slate-50/80 transition text-sm">
                        <td class="px-6 py-3">
                            <div class="font-semibold text-slate-900">@item.FullName</div>
                            <div class="text-xs text-slate-500">ID: #PT-@item.Id.ToString("D4")</div>
                        </td>

                        <td class="px-6 py-3 text-sm text-slate-800">
                            <div class="font-medium">@item.LastVisitRelative</div>
                            <div class="text-xs text-slate-500">@(item.LastVisit?.ToString("MMM dd, yyyy") ?? "No history")</div>
                        </td>

                        <td class="px-6 py-3 text-sm text-slate-800">
                            <div class="font-medium">@item.PrimaryDoctor</div>
                            <div class="text-xs text-slate-500">Care coordinator</div>
                        </td>

                        <td class="px-6 py-3 text-sm">
                            <div class="flex flex-wrap gap-2">
                                @foreach (var flag in item.ClinicalFlags)
                                {
                                    <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ring-inset @GetFlagClass(flag)">
                                        <span class="h-2 w-2 rounded-full bg-current/60"></span>
                                        @flag
                                    </span>
                                }
                            </div>
                        </td>

                        <td class="px-6 py-3 text-sm text-slate-700">
                            <div class="font-medium text-slate-900">@item.Phone</div>
                            <div class="text-xs text-slate-500">@item.Email</div>
                        </td>

                        <td class="px-6 py-3">
                            <details class="relative group w-full text-right">
                                <summary class="inline-flex items-center justify-end gap-2 rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-sm font-semibold text-slate-700 hover:bg-slate-50 cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500">
                                    Actions
                                    <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                </summary>
                                <div class="absolute right-0 mt-2 w-48 rounded-lg border border-slate-200 bg-white shadow-lg ring-1 ring-black/5">
                                    <ul class="py-1 text-left text-sm text-slate-700">
                                        <li>
                                            <a asp-action="Details" asp-route-id="@item.Id" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 focus:bg-slate-50">
                                                <span class="w-2 h-2 rounded-full bg-brand-500"></span> View
                                            </a>
                                        </li>
                                        <li>
                                            <a asp-action="Edit" asp-route-id="@item.Id" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 focus:bg-slate-50">
                                                <span class="w-2 h-2 rounded-full bg-amber-500"></span> Edit
                                            </a>
                                        </li>
                                        <li>
                                            <a href="@Url.Action("Create", "Appointments", new { patientId = item.Id })" class="flex items-center gap-2 px-3 py-2 hover:bg-slate-50 focus:bg-slate-50">
                                                <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Schedule Appointment
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </details>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
