@* File: Views/Billing/Index.cshtml *@
@model MedicalOfficeManagement.ViewModels.Billing.BillingIndexViewModel

@{
    ViewBag.Title = "Billing";
    var canEditBilling = User.IsInRole(nameof(AppRole.Admin)) || User.IsInRole(nameof(AppRole.Billing));
}

<div class="space-y-6">
    @await Html.PartialAsync("Partials/PageHeader", new PageHeaderModel
    {
        Title = "Billing",
        Subtitle = "Finance dashboard with AR aging and payment activity.",
        ContextTag = "Finance",
        RoleBadge = canEditBilling ? "Billing control" : "View only",
        RoleTone = canEditBilling ? "success" : "warning",
        Actions = new []
        {
            new ToolbarAction { Label = "Create invoice", Style = "primary", DataTarget = "#invoice-modal", IsButton = true, Disabled = !canEditBilling },
            new ToolbarAction { Label = "Export AR", Href = Url.Action("Index", "Reports"), Style = "secondary" }
        }
    })

    @await Html.PartialAsync("Partials/KpiGrid", new KpiGridModel
    {
        Items = new []
        {
            new KpiCardModel { Label = "Total Due", Value = $"${Model.TotalDue:N2}", Helper = "Outstanding balance", DeltaTone = "warning", Delta = "Watch aging" },
            new KpiCardModel { Label = "Paid This Month", Value = $"${Model.PaidThisMonth:N2}", Helper = "Collected and reconciled", DeltaTone = "success" },
            new KpiCardModel { Label = "Overdue Invoices", Value = Model.OverdueCount.ToString(), Helper = "Needs follow-up", DeltaTone = "danger" },
            new KpiCardModel { Label = "Collection Rate", Value = "93%", Helper = "Month-to-date success", DeltaTone = "neutral" }
        }
    })

    <div class="card p-5 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <label class="form-label">Search</label>
                <div class="relative">
                    <input type="text"
                           placeholder="Search by patient name or invoice ID..."
                           class="form-input pl-10">
                    <span class="iconify absolute left-3 top-2.5 w-5 h-5 text-slate-400" data-icon="solar:magnifer-bold"></span>
                </div>
            </div>
            <div>
                <label class="form-label">Status</label>
                <select class="form-input">
                    <option>All Status</option>
                    <option>Paid</option>
                    <option>Unpaid</option>
                    <option>Overdue</option>
                </select>
            </div>
            <div>
                <label class="form-label">Sort By</label>
                <select class="form-input">
                    <option>Due Date</option>
                    <option>Amount (High to Low)</option>
                    <option>Amount (Low to High)</option>
                    <option>Patient Name</option>
                </select>
            </div>
        </div>
    </div>

    @await Html.PartialAsync("Partials/TableShell", new TableShellModel
    {
        Title = "Invoices",
        Description = "Status pills, due dates, and role-aware actions.",
        Actions = new [] { new ToolbarAction { Label = "Create invoice", DataTarget = "#invoice-modal", IsButton = true, Style = "primary", Disabled = !canEditBilling } },
        TableContent = @<text>
            @if (!Model.Invoices.Any())
            {
                @await Html.PartialAsync("Partials/EmptyState", new EmptyStateModel
                {
                    Title = "No invoices recorded",
                    Body = "Create the first invoice to start tracking billing performance.",
                    Icon = "solar:bill-list-bold",
                    PrimaryAction = new ToolbarAction { Label = "Create invoice", Style = "primary", DataTarget = "#invoice-modal", IsButton = true, Disabled = !canEditBilling }
                })
            }
            else
            {
                <table>
                    <thead>
                        <tr>
                            <th>Invoice ID</th>
                            <th>Patient</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var invoice in Model.Invoices)
                        {
                            var tone = invoice.StatusColor?.Contains("green") == true
                                ? "badge success"
                                : invoice.StatusColor?.Contains("red") == true
                                    ? "badge danger"
                                    : "badge warning";
                            <tr>
                                <td class="font-semibold text-slate-900">#@invoice.Id</td>
                                <td>
                                    <div class="text-sm font-semibold text-slate-900">@invoice.PatientName</div>
                                    <div class="text-xs text-slate-500">Invoice: @invoice.InvoiceDate.ToString("MMM dd, yyyy")</div>
                                </td>
                                <td class="font-semibold text-slate-900">$@invoice.Amount.ToString("N2")</td>
                                <td><span class="@tone">@invoice.Status</span></td>
                                <td class="text-sm text-slate-600">@invoice.DueDate.ToString("MMM dd, yyyy")</td>
                                <td class="text-right">
                                    @await Html.PartialAsync("Partials/ActionMenu", new ActionMenuModel
                                    {
                                        Items = new List<ActionMenuItem>
                                        {
                                            new ActionMenuItem { Label = "View Details", Href = Url.Action("Details", "Billing", new { id = invoice.Id }) },
                                            new ActionMenuItem
                                            {
                                                Label = "Record Payment",
                                                Href = invoice.Status != "Paid" && canEditBilling ? Url.Action("RecordPayment", "Billing", new { id = invoice.Id }) : null,
                                                Disabled = invoice.Status == "Paid" || !canEditBilling,
                                                Tone = "success"
                                            }
                                        }
                                    })
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </text>
    })
</div>

<div id="invoice-modal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 hidden">
    <div class="surface w-full max-w-2xl p-6 space-y-4 shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-slate-900">Create Invoice</h2>
                <p class="text-sm text-slate-500">Capture invoice details directly from the billing dashboard.</p>
            </div>
            <button type="button" class="text-slate-400 hover:text-slate-600" data-close-modal>
                <span class="sr-only">Close</span>
                &times;
            </button>
        </div>
        <form action="@Url.Action("Create", "Billing")" method="post" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="form-label">Patient Name</label>
                    <input type="text" name="PatientName" class="form-input" placeholder="Patient full name" required>
                </div>
                <div class="form-field">
                    <label class="form-label">Invoice Date</label>
                    <input type="date" name="InvoiceDate" class="form-input" required>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="form-field sm:col-span-2">
                    <label class="form-label">Services</label>
                    <input type="text" name="Services" class="form-input" placeholder="e.g., Consultation, Labs">
                </div>
                <div class="form-field">
                    <label class="form-label">Amount</label>
                    <input type="number" name="Amount" step="0.01" class="form-input" placeholder="125.00" required>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="form-field">
                    <label class="form-label">Status</label>
                    <select name="Status" class="form-input">
                        <option value="Pending">Pending</option>
                        <option value="Unpaid">Unpaid</option>
                        <option value="Paid">Paid</option>
                        <option value="Overdue">Overdue</option>
                    </select>
                </div>
                <div class="form-field">
                    <label class="form-label">Due Date</label>
                    <input type="date" name="DueDate" class="form-input" required>
                </div>
            </div>
            <div class="form-field">
                <label class="form-label">Notes</label>
                <textarea name="Notes" rows="3" class="form-textarea" placeholder="Additional billing notes"></textarea>
            </div>
            <div class="flex items-center justify-end gap-3 pt-2">
                <button type="button" class="btn-secondary" data-close-modal>Cancel</button>
                <button type="submit" class="btn-primary">Save Invoice</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('invoice-modal');
        const triggers = document.querySelectorAll('[data-target=\"#invoice-modal\"]');

        const toggleModal = (isOpen) => {
            modal?.classList.toggle('hidden', !isOpen);
        };

        triggers.forEach(trigger => trigger?.addEventListener('click', () => toggleModal(true)));
        modal?.addEventListener('click', (event) => {
            if (event.target === modal) {
                toggleModal(false);
            }
        });

        document.querySelectorAll('[data-close-modal]').forEach(button => {
            button.addEventListener('click', () => toggleModal(false));
        });
    });
</script>
